---
title: Uniswap V3 CPMM Variable  # 글 제목
date: 2026-01-28 00:00:00 +0900 # 작성 시간
categories: [web3, DEX] # 카테고리
tags: [web3, uniswap, CPMM]     # 태그
---

## CPMM 예시 및 키워드 정리
아래가 CPMM의 식이다.
$$
X * Y = K
$$

```
X: x 토큰의 리저브 개수
Y: y 토큰의 리저브 개수
K: x/y 풀의 리저브 개수
```

![](/assets/img/image.png){:width="50%" height="50px"}


$X: 1,000, Y: 4,000$ 라고 하면 $K: 4,000,000$ 로 고정이 된다.\
이후 새로운 유동성이 공급되거나 기존의 유동성이 빠져나갈때 값이 변할 수 있다.

여기서 Uniswap은 토큰 스왑의 기준이 되는 **토큰 유동성**을 다음과 같이 정의한다.
$$
L = \sqrt{X * Y}
$$
따라서 위의 예시에 따르면 $L$ 값은
$$
L = \sqrt{X * Y} = \sqrt{1,000 * 4,000} = 2,000
$$
여기서 $L^2$ 은 위에서 확인한 $K$ 와 같다는 것을 알 수 있다.
또 기억해야할 부분은 $L^2$는 **풀 전체의 유동성**을 의미하고, $L$은 풀 구성하는 토큰 한 개에 대한 **기준 유동성**을 의미한다.

이제 **토큰의 유동성 가치**를 알아보자.\
$P_x$ 를 X의 가치(가격)이라 하면, x 토큰의 가치는 다음과 같다.
$$
L_x = X * P_x
$$
y 토큰도 아래와 같다.
$$
L_y = Y * P_y
$$

이제 $L_v$를 풀의 토큰 유동성 가치라고 하면 다음과 같다.
$$
L_v = L * \sqrt{P}
$$

$\sqrt{P}$ 는 토큰 한 개에 대한 풀의 기준 가격을 의미한다. 풀에 유동성이 공급될 때는 동일 한 가치를 같도록 x, y 토큰을 1:1로 예치를 하여 아래 식이 성립된다.
$$
L_v = L_x = L_y
$$

이를 통해서 앞의 식을 다시 정리해보면 아래와 같다.\
$$
\begin{aligned}
&L_v^2 = L_x * L_y = (X * P_x) * (Y * P_y) = (X * Y) * (P_x * P_y) \\
&L_v = \sqrt{X * Y} * \sqrt{P_x * P_y}
\end{aligned}
$$

그러면 아래가 성립하고
$$
\begin{aligned}
&L = \sqrt{X * Y}\\
&\sqrt{P} = \sqrt{P_x * P_y}
\end{aligned}
$$

그러면 풀의 기준 가격인 $\sqrt{P}$ 에 대해 아래처럼 정리할 수 있다.

$$
P=P_x * P_y\\
$$
$$
\therefore \sqrt{P} = P_x\quad or\quad P_y
$$

그럼 다시 위 예시로 계산을 해보자.

$$
\begin{aligned}
&P_x = \frac{L_x}{X} = \frac{2,000}{1,000} = 2\ \$ \\
&P_y = \frac{L_x}{Y} = \frac{2,000}{4,000} = 0.5\ \$
\end{aligned}
$$

풀의 기준 가격을 결정하기 위해서는 기준으로 삼을 토큰을 정해야한다. 여기서는 x를 기준 토큰으로 삼아보자. ($\sqrt{P} = P_x$)
$$
\sqrt{P} = P_x = \frac{L_x}{X} = \frac{\sqrt{X*Y}}{X} = \sqrt{\frac{Y}{X}}\\
$$
$$
\therefore \sqrt{P} = \sqrt{\frac{Y}{X}}
$$

바로 이 $\sqrt{P}$ 가 풀의 현재 상태를 나타내는 가장 기초적인 지표이다. Uniswap V3, V4는 reserve 값을 저장하지 않고 수학적 효율성과 정밀도를 위해 $\sqrt{P}$ 와 $L$ 을 상태 변수로써 활용한다.

### Reserve 유도
$\sqrt{P}$ 와 $L$ 을 가지고 토큰의 reserve 개수를 나타내는 $X, Y$ 표현할 수 있다.

$$
\begin{aligned}
&L=\sqrt{X*Y}\\
&\sqrt{P} = \sqrt{\frac{X}{Y}}\\
&\frac{L}{\sqrt{P}} = \sqrt{X*Y}*\sqrt{\frac{X}{Y}} = X\\
&L*\sqrt{P} = \sqrt{X*Y}*\sqrt{\frac{Y}{X}} = Y
\end{aligned}
$$

이를 통해 uniswap v3, V4는 직접 reserve 변수 값을 저장하지 않고 상태만을 저장하게 된다.\
V3는 CPMM 함수가 아래처럼 바뀐다.

$$
L^2 = (X+\frac{L}{\sqrt{P_b}}) * (Y + L * \sqrt{P_a})
$$
지금까지 각 변수들에 대해 공부했으니, V3에서 들어온 Concentrated liquidity에서 어떻게 스왑이 일어나는지를 알아보자.

## Concentradted Liquidity Swap

![alt text](/assets/img/image-1.png){:width="50%" height="50px"}

평행 이동 (Parallel Shifting)v3는 특정 구간($P_a, P_b$)에서 자산이 0이 되게 만들어야 합니다.\
이를 위해 실제 자산($x, y$)에 가상의 양을 더해 수식을 강제로 맞춥니다.
$$
(x + \frac{L}{\sqrt{P_b}})(y + L\sqrt{P_a}) = L^2
$$
왜 더하는가? (왼쪽/아래쪽 이동):원래 곡선($x \cdot y = L^2$)은 $x=0$이 되려면 $y$가 무한대여야 합니다.\
하지만 우리는 가격이 $P_b$일 때(즉, $y$가 특정 유한한 값일 때) $x$를 0으로 만들고 싶습니다.\
따라서 실제 $x$에 $\frac{L}{\sqrt{P_b}}$만큼의 **가상 값**을 더해줍니다.\ 
이렇게 하면 실제 $x$가 0이 되어도 공식상으로는 여전히 양수($\frac{L}{\sqrt{P_b}}$)가 되어 수학적 성립이 가능해집니다.\
그래프 관점에서는 곡선을 왼쪽($x$축 음의 방향)과 아래쪽($y$축 음의 방향)으로 밀어낸 것과 같습니다.\
이 이동을 통해 곡선의 일부분이 $x$축과 $y$축에 닿게(자산이 0이 되게) 만드는 것입니다.